<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meta-L Audio Controller</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Firebase debug logging (remove in production)
        setLogLevel('debug'); 

        // Placeholder for app ID and Firebase config (will be populated by the environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-meta-l-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let currentSpeakerModel = 'Mini 5"'; 
        
        // --- 1. DEFINE INITIAL DATA ---
        let availableBluetoothDevices = ['Phone X', 'Laptop Pro', 'Tablet Go']; // Now dynamic
        const initialPresets = {
            'Flat': { low: 50, lowMid: 50, mid: 50, highMid: 50, high: 50 },
            'Rock': { low: 80, lowMid: 60, mid: 40, highMid: 70, high: 90 },
            'Acoustic': { low: 30, lowMid: 70, mid: 85, highMid: 70, high: 40 },
            'Custom 1': { low: 50, lowMid: 50, mid: 50, highMid: 50, high: 50 } 
        };
        const initialSpeakerModels = ['Mini 5"', 'Mini 8"', 'Sphere', 'Aura', 'Subwoofer'];
        const initialSpeakerConfigs = {
            'Mini 5"': { model: 'Mini 5"', power: true, volume: 50, connectedDevice: 'Phone X', eq: initialPresets.Flat },
            'Mini 8"': { model: 'Mini 8"', power: true, volume: 60, connectedDevice: 'Laptop Pro', eq: initialPresets.Rock },
            'Sphere': { model: 'Sphere', power: false, volume: 40, connectedDevice: null, eq: initialPresets.Acoustic },
            'Aura': { model: 'Aura', power: true, volume: 75, connectedDevice: 'Tablet Go', eq: initialPresets.Flat },
            'Subwoofer': { model: 'Subwoofer', power: false, volume: 80, connectedDevice: null, eq: initialPresets.Rock }
        };

        // --- FIX: Initialize allPresets with default data immediately ---
        let allPresets = JSON.parse(JSON.stringify(initialPresets)); 
        let currentConfig = JSON.parse(JSON.stringify(initialSpeakerConfigs[currentSpeakerModel]));

        // --- NEW MEDIA CONTROL STATE ---
        let isPlaying = false; 

        // --- Core Slider Visual Functionality (used by EQ) ---
        const fillSliderTrack = (sliderElement) => {
            const value = sliderElement.value;
            const min = sliderElement.min || 0;
            const max = sliderElement.max || 100;
            const percent = ((value - min) / (max - min)) * 100;
            // Use subtle gradient for the filled track to enhance metallic feel
            sliderElement.style.background = `linear-gradient(to right, var(--gold-base) 0%, var(--gold-dark) ${percent}%, #333333 ${percent}%, #333333 100%)`;
        };

        // --- Firebase Initialization & Authentication ---
        const initFirebase = async () => {
            if (!Object.keys(firebaseConfig).length) {
                console.warn("Firebase config not provided. Running in demo mode without persistence.");
                userId = crypto.randomUUID(); // Generate a local unique ID
                document.getElementById('user-id-display').textContent = 'USER: OFFLINE';
                document.getElementById('app-status').textContent = 'DEMO MODE';
                // In demo mode, still set up UI
                setupSpeakerSelectionButtons(); 
                setupBluetoothDeviceList();
                updateUI(currentConfig); // Initial UI update with demo data
                renderPresetButtons(); 
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                // Fallback to demo mode if auth fails
                userId = crypto.randomUUID();
                document.getElementById('user-id-display').textContent = 'USER: AUTH FAILED';
                document.getElementById('app-status').textContent = 'DEMO MODE';
                setupSpeakerSelectionButtons(); 
                setupBluetoothDeviceList();
                updateUI(currentConfig);
                renderPresetButtons();
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = `USER: ${userId.substring(0, 8)}...`;
                    document.getElementById('app-status').textContent = 'CONNECTED';
                    listenForPresets(); 
                    setupSpeakerSelectionButtons(); 
                    setupBluetoothDeviceList();
                    listenForSpeakerConfig();
                } else {
                    userId = crypto.randomUUID(); // Fallback to anonymous ID if state changes unexpectedly
                    document.getElementById('app-status').textContent = 'DISCONNECTED';
                    document.getElementById('user-id-display').textContent = 'USER: ANONYMOUS';
                }
            });
        };

        // --- Firebase Document Reference Helpers ---
        const getSpeakerDocRef = (model) => {
            if (!db || !userId) return null; // Ensure db and userId are available
            const path = `/artifacts/${appId}/users/${userId}/speaker_configs/${model}`;
            return doc(db, path);
        };

        const getPresetsDocRef = () => {
             if (!db || !userId) return null; // Ensure db and userId are available
            const path = `/artifacts/${appId}/users/${userId}/global_settings/eq_presets`;
            return doc(db, path);
        };

        // --- Data Persistence (Firestore write) ---
        const updateSpeakerConfig = async (newFields) => {
            if (!db || !userId) {
                // Handle demo mode: update local config only
                currentConfig = { ...currentConfig, ...newFields };
                updateUI(currentConfig); // Reflect changes immediately
                return;
            }

            const docRef = getSpeakerDocRef(currentSpeakerModel);
            if (!docRef) return;

            const updatedConfig = { ...currentConfig, ...newFields };
            await setDoc(docRef, updatedConfig, { merge: true })
                .then(() => console.log(`Config updated for ${currentSpeakerModel}`))
                .catch(e => console.error("Error updating config:", e));
        };

        // --- Real-time Data Listeners (Firestore read) ---
        const listenForSpeakerConfig = () => {
            if (!db || !userId) return; // Only run if Firebase is connected

            initialSpeakerModels.forEach(model => {
                const docRef = getSpeakerDocRef(model);
                onSnapshot(docRef, (docSnap) => {
                    let data = docSnap.exists() ? docSnap.data() : {};
                    const mergedData = { 
                        ...initialSpeakerConfigs[model], // Start with base config
                        ...data, // Overlay saved data
                        eq: { 
                            ...(initialSpeakerConfigs[model].eq), // Ensure base EQ structure
                            ...(data.eq || allPresets.Flat) // Apply saved EQ or Flat preset
                        } 
                    };
                    if (model === currentSpeakerModel) {
                        currentConfig = mergedData; // Update local state for current speaker
                        updateUI(mergedData); // Trigger UI refresh
                    }
                }, (error) => {
                    console.error("Firestore snapshot error for model", model, ":", error);
                    // Fallback to initial config if there's a read error
                    if (model === currentSpeakerModel) {
                        currentConfig = initialSpeakerConfigs[model];
                        updateUI(currentConfig);
                    }
                });
            });
        };

        const listenForPresets = () => {
            if (!db || !userId) return; // Only run if Firebase is connected

            const docRef = getPresetsDocRef();
            if (!docRef) return;

            onSnapshot(docRef, (docSnap) => {
                const data = docSnap.exists() ? docSnap.data() : {};
                allPresets = { ...initialPresets, ...data }; // Merge default with saved
                renderPresetButtons(); // Re-render buttons with updated presets
            }, (error) => {
                console.error("Firestore preset snapshot error:", error);
                allPresets = initialPresets; // Fallback to default presets
                renderPresetButtons();
            });
        };

        // --- UI Update Function (Main rendering logic) ---
        const updateUI = (config) => {
            if (!config) return;

            // Speaker Selector Buttons (Gold filled for active)
            document.querySelectorAll('.speaker-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.modelName === config.model);
            });
            
            // Bluetooth Device Buttons (Gold filled for connected)
            const connectedDeviceName = config.connectedDevice;
            document.querySelectorAll('.bt-device-btn').forEach(button => {
                const isConnected = button.dataset.deviceName === connectedDeviceName;
                button.classList.toggle('bt-connected', isConnected);
                button.textContent = isConnected ? `${button.dataset.deviceName} (Connected)` : button.dataset.deviceName;
            });
            
            // EQ Sliders and Values
            ['low', 'lowMid', 'mid', 'highMid', 'high'].forEach(band => {
                const slider = document.getElementById(`${band}-slider`);
                const valueDisplay = document.getElementById(`${band}-value`);
                if (slider && valueDisplay) {
                    slider.value = config.eq[band];
                    valueDisplay.textContent = config.eq[band];
                    fillSliderTrack(slider); // Update gold fill for each slider
                }
            });

            // Set the 'Flat' preset button as active by default, or the applied preset if applicable
            document.querySelectorAll('.preset-btn').forEach(btn => {
                const presetName = btn.dataset.presetName;
                const isActive = JSON.stringify(config.eq) === JSON.stringify(allPresets[presetName]);
                btn.classList.toggle('active', isActive);
            });

            currentConfig = config; // Keep currentConfig up-to-date locally
            updatePlayPauseButton(); // Ensure media buttons reflect current state on config change
        };

        // --- NEW MEDIA CONTROL FUNCTIONS ---
        const updatePlayPauseButton = () => {
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            
            if (playIcon && pauseIcon) {
                if (isPlaying) {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                } else {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                }
            }
        };

        const togglePlayPause = () => {
            isPlaying = !isPlaying;
            updatePlayPauseButton();
            console.log(`Media Action: ${isPlaying ? 'PLAY' : 'PAUSE'}`);
            document.getElementById('app-status').textContent = isPlaying ? 'PLAYING' : 'PAUSED';
            // TWA Logic: send command to server
        };

        const controlAction = (action) => {
            console.log(`Media Action: ${action.toUpperCase()}`);
            isPlaying = true; // Assume playback starts after skipping/previous
            updatePlayPauseButton();
            document.getElementById('app-status').textContent = `TRACK ${action.toUpperCase()}...`;
            // TWA Logic: send command to server
        };
        // --- END NEW MEDIA CONTROL FUNCTIONS ---


        // --- UI Component Initialization ---
        const setupSpeakerSelectionButtons = () => {
            const container = document.getElementById('speaker-buttons-container');
            container.innerHTML = ''; // Clear existing buttons
            initialSpeakerModels.forEach(model => {
                const button = document.createElement('button');
                button.textContent = model;
                button.className = 'speaker-btn font-light transition duration-200';
                button.dataset.modelName = model;
                button.onclick = () => handleSpeakerButtonClick(model);
                container.appendChild(button);
            });
            updateUI(currentConfig); // Ensure correct speaker button is highlighted
        };

        const setupBluetoothDeviceList = () => {
            const listElement = document.getElementById('bluetooth-device-list');
            listElement.innerHTML = ''; // Clear existing buttons
            availableBluetoothDevices.forEach(device => {
                const button = document.createElement('button'); 
                button.className = 'bt-device-btn font-light transition duration-200';
                button.dataset.deviceName = device;
                button.textContent = device; 
                button.addEventListener('click', () => {
                    handleBluetoothClick(button.dataset.deviceName);
                });
                listElement.appendChild(button);
            });
            updateUI(currentConfig); // Ensure correct BT button is highlighted
        };

        const renderPresetButtons = () => {
            const container = document.getElementById('preset-buttons');
            container.innerHTML = ''; // Clear existing buttons
            
            // This loop uses allPresets, which is now guaranteed to have defaults
            Object.keys(allPresets).forEach(name => {
                const button = document.createElement('button');
                button.textContent = name;
                button.className = 'preset-btn font-light transition duration-150';
                button.dataset.presetName = name;
                button.onclick = () => applyPreset(name); // Directly apply preset on click
                container.appendChild(button);
            });
            updateUI(currentConfig); // Ensure correct preset button is highlighted
        };


        // --- Event Handlers ---
        const handleSpeakerButtonClick = (modelName) => {
            if (modelName === currentSpeakerModel) return; // No change needed
            currentSpeakerModel = modelName;
            // The Firestore listener for this model will trigger updateUI, or in demo mode, directly update
            updateUI(initialSpeakerConfigs[modelName]); 
        };

        const handleBluetoothClick = (deviceName) => {
            const newDevice = currentConfig.connectedDevice === deviceName ? null : deviceName; // Toggle logic
            updateSpeakerConfig({ connectedDevice: newDevice });
        };

        const handleEQChange = (band, value) => {
            const newEQ = { ...currentConfig.eq, [band]: parseInt(value, 10) };
            updateSpeakerConfig({ eq: newEQ });
        };

        const applyPreset = (presetName) => {
            const eqSettings = allPresets[presetName];
            if (eqSettings) {
                updateSpeakerConfig({ eq: eqSettings });
            } else {
                console.error(`Preset not found: ${presetName}`);
            }
        };

        const saveCustomPreset = async () => {
            const presetName = 'Custom 1'; 
            const newEQ = currentConfig.eq;
            
            if (!db || !userId) {
                // Using a custom modal/message box instead of alert()
                const message = "Cannot save custom preset in Demo Mode.";
                console.warn(message);
                // Simple on-screen notification (best practice for mobile)
                const status = document.getElementById('app-status');
                status.textContent = message;
                status.classList.add('text-red-500', 'font-bold');
                setTimeout(() => {
                     status.textContent = 'DEMO MODE';
                     status.classList.remove('text-red-500', 'font-bold');
                }, 2000);
                return;
            }

            const docRef = getPresetsDocRef();
            if (!docRef) return;

            await setDoc(docRef, { [presetName]: newEQ }, { merge: true })
                .then(() => {
                    document.getElementById('save-preset-btn').textContent = "SAVED!";
                    setTimeout(() => {
                        document.getElementById('save-preset-btn').textContent = "SAVE CUSTOM 1";
                    }, 1500);
                })
                .catch(e => console.error("Error saving custom preset:", e));
        };

        const setupEventListeners = () => {
            document.getElementById('reset-eq-btn').addEventListener('click', () => applyPreset('Flat'));
            document.getElementById('save-preset-btn').addEventListener('click', saveCustomPreset);

            // EQ Slider Input/Change Listeners
            ['low', 'lowMid', 'mid', 'highMid', 'high'].forEach(band => {
                const slider = document.getElementById(`${band}-slider`);
                slider.addEventListener('input', (e) => {
                    document.getElementById(`${band}-value`).textContent = e.target.value;
                    fillSliderTrack(e.target); 
                });
                slider.addEventListener('change', (e) => {
                    handleEQChange(band, e.target.value);
                });
            });

            // --- NEW VOLUME SLIDER LISTENER ---
            const volumeSlider = document.getElementById('volume-slider-media');
            const volumeValue = document.getElementById('volume-value-media');
            if (volumeSlider) {
                // Initialize display
                volumeValue.textContent = volumeSlider.value;
                volumeSlider.addEventListener('input', (e) => {
                    volumeValue.textContent = e.target.value;
                    // No gold fill for this slider, use default Tailwind style for contrast
                    console.log('Volume output set to:', e.target.value);
                });
            }

            // NEW: Bluetooth Scan Listener
            document.getElementById('scan-btn').addEventListener('click', scanBluetoothDevices);

            // NEW: Source Button Listener
            document.getElementById('source-btn').addEventListener('click', () => {
                document.getElementById('source-list').classList.toggle('hidden');
            });
        };

        // NEW: Bluetooth Scan Function (Discovers nearby BLE devices)
        const scanBluetoothDevices = async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true });
                const deviceName = device.name || 'Unknown Device';
                if (!availableBluetoothDevices.includes(deviceName)) {
                    availableBluetoothDevices.push(deviceName);
                    setupBluetoothDeviceList();
                    console.log(`Added device: ${deviceName}`);
                }
            } catch (error) {
                console.error('Bluetooth scan error:', error);
                alert('Scan failed. Ensure Bluetooth is on and permissions granted.');
            }
        };

        // NEW: Open Source Function (Launches apps via deep links)
        const openSource = (app) => {
            let url;
            switch (app) {
                case 'youtube':
                    url = 'vnd.youtube://';
                    break;
                case 'spotify':
                    url = 'spotify://';
                    break;
                // Add more as needed, e.g., 'applemusic': 'music://', 'amazonmusic': 'com.amazon.mp3://'
                default:
                    url = 'https://www.google.com'; // Fallback
            }
            window.location.href = url;
            document.getElementById('source-list').classList.add('hidden'); // Hide list after selection
        };

        // --- PWA Service Worker Registration ---
        const registerServiceWorker = () => {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    // Note: sw.js path is relative to the root of the site, which is the MetaL_PWA folder
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => console.log('SW registered: ', registration))
                        .catch(registrationError => console.log('SW registration failed: ', registrationError));
                });
            }
        };


        // --- Main execution when DOM is ready ---
        window.onload = () => {
            initFirebase();
            setupEventListeners();
            registerServiceWorker(); // Register the PWA service worker
            
            // --- FIX: Guarantee initial render of presets immediately ---
            renderPresetButtons(); 
            // Ensure media buttons reflect initial state
            updatePlayPauseButton();
        };

    </script>
    
    <style>
        /* Base Styles */
        :root {
            /* Adjusted Gold Tones to better match your logo */
            --gold-base: #C49A4C; /* A warmer, deeper gold */
            --gold-light: #F0DDA5; /* A subtle highlight color */
            --gold-dark: #8C6A35; /* A rich, darker tone for depth */
            --black-background: #000000;
            --card-background: #1a1a1a;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--black-background); 
            color: #FFFFFF; 
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 100vh;
            overflow-x: hidden; 
        }

        /* Gold Accent Color (Simulated Metallic Look) */
        .text-gold-accent { color: var(--gold-base); } 
        .bg-gold-accent { background-color: var(--gold-base); }
        .border-gold-accent { border-color: var(--gold-base); }

        /* Font Weights (300 for slimness everywhere) */
        .font-light { font-weight: 300; } 
        .font-medium { font-weight: 400; } 
        .font-bold { font-weight: 700; }

        /* Main Card Styling */
        .card {
            background-color: var(--card-background); 
            border-radius: 1.5rem; 
            padding: 1.75rem 1.5rem; 
            width: 100%;
            max-width: 24rem; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.8); 
            display: flex;
            flex-direction: column;
            gap: 1.5rem; 
            margin-top: 2rem; 
            margin-bottom: 2rem;
        }

        /* Header (Logo & Title) */
        #main-header-content {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 0.25rem; 
            margin-bottom: 0.5rem; 
        }
        #main-header-content img {
            width: 3.5rem; /* Standard logo size */
            height: auto;
            margin-bottom: 0.25rem;
            /* Filter to give a subtle glow, enhancing the metallic shine */
            filter: drop-shadow(0 0 8px rgba(196, 154, 76, 0.7)); /* Adjusted glow to new gold tone */
        }
        #main-header-content h1 {
            font-size: 1.25rem; /* Adjusted size for balance with logo */
            letter-spacing: 0.25em; 
            line-height: 1.2;
            font-weight: 300; 
        }
        #main-header-content p.text-gold-accent {
            font-size: 0.6rem; 
            letter-spacing: 0.18em; 
            font-weight: 300;
        }

        /* Section Headings */
        h3 {
            font-size: 0.8rem; 
            letter-spacing: 0.1em;
            text-transform: uppercase;
            font-weight: 400; 
            color: #ccc; 
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #333333; 
            text-align: center; 
        }

        /* --- Custom Range Slider Styling (Metallic Thumb - Used by EQ) --- */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px; 
            background: #333333; 
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }
        /* Overriding Tailwind for the Volume Slider to match the metallic aesthetic */
        #volume-slider-media {
            background: #333333; 
            border-radius: 2px;
            height: 4px; 
        }


        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px; 
            height: 18px;
            border-radius: 50%;
            /* Use radial gradient for polished, metallic sphere look */
            background: radial-gradient(circle at 70% 30%, var(--gold-light), var(--gold-base), var(--gold-dark)); 
            border: 1px solid var(--gold-dark); /* Darker border for definition */
            margin-top: -7px; 
            /* Enhanced metallic shadow and glow */
            box-shadow: 
                0 0 10px rgba(196, 154, 76, 0.8), /* Softer outer glow, matching new gold */
                inset 0 0 6px rgba(240, 221, 165, 0.8), /* Bright inner highlight */
                0 3px 5px rgba(0, 0, 0, 0.8); /* Deeper drop shadow */
            transition: all 0.1s ease-in-out;
        }
        input[type="range"]::-webkit-slider-thumb:active {
            box-shadow: 
                0 0 15px rgba(196, 154, 76, 1), 
                inset 0 0 8px rgba(240, 221, 165, 1),
                0 4px 7px rgba(0, 0, 0, 0.9);
            transform: scale(1.05);
        }

        /* --- Button Base Styling (EQ/BT/Speaker) --- */
        .speaker-btn, .preset-btn, .bt-device-btn {
            background-color: transparent;
            color: var(--gold-light); /* Text color now uses a lighter gold for better contrast */
            border: 1px solid var(--gold-base); 
            white-space: nowrap; 
            flex-shrink: 0;
            text-shadow: 0 0 2px rgba(240, 221, 165, 0.5); /* Subtle text glow */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            padding: 0.2rem 0.4rem; 
            font-size: 0.6rem; 
            border-radius: 0.5rem; 
            flex-grow: 1; 
            text-align: center;
        }
        
        /* --- Active/Connected State: METALLIC GOLD FILL --- */
        .speaker-btn.active, .preset-btn.active, .bt-device-btn.bt-connected {
            /* Use a gradient to simulate reflective metal */
            background: linear-gradient(145deg, var(--gold-base), var(--gold-dark)); /* Deeper, richer gradient */
            color: #111111; /* Dark text on active gold */
            /* Combined shadows for deep metallic effect */
            box-shadow: 
                0 0 15px rgba(196, 154, 76, 0.9), 
                inset 0 0 6px rgba(240, 221, 165, 0.9), /* Bright inner highlight */
                inset 0 0 15px rgba(140, 106, 53, 0.5), /* Darker edge for depth */
                0 4px 8px rgba(0, 0, 0, 0.6); /* Deep drop shadow */
            text-shadow: none;
            border: 1px solid var(--gold-base); 
        }

        /* Hover State for Buttons */
        .speaker-btn:hover, .preset-btn:hover, .bt-device-btn:hover {
            background-color: rgba(196, 154, 76, 0.15); /* Softer hover highlight */
            box-shadow: 0 0 8px rgba(196, 154, 76, 0.5);
            color: var(--gold-light);
        }
        .speaker-btn.active:hover, .preset-btn.active:hover, .bt-device-btn.bt-connected:hover {
             background-color: var(--gold-base); /* Hover over active is still gold */
        }
        
        /* --- NEW: Media Control Button Styles --- */
        .control-button {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        .control-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
        }
        /* Gold Play Button Specific Styling */
        #play-pause-btn {
            background: linear-gradient(145deg, var(--gold-light), var(--gold-base), var(--gold-dark)); 
            color: #111; /* Dark icon on gold */
            box-shadow: 0 0 20px rgba(196, 154, 76, 0.8), 0 8px 20px rgba(0, 0, 0, 0.8);
            border: 2px solid var(--gold-light);
        }
        #play-pause-btn:active {
            box-shadow: 0 0 10px rgba(196, 154, 76, 0.5), 0 4px 10px rgba(0, 0, 0, 0.6);
        }

        /* Save Custom 1 Button (Smaller, Thinner Metallic Bar Look) */
        #save-preset-btn {
            margin-top: 1rem; 
            padding: 0.6rem; 
            font-size: 0.75rem; 
            font-weight: 500; 
            border-radius: 0.75rem; 
            background: linear-gradient(145deg, var(--gold-base), var(--gold-dark)); 
            color: #FFFFFF; 
            box-shadow: 
                0 0 12px rgba(196, 154, 76, 0.8), 
                inset 0 0 6px rgba(240, 221, 165, 0.6), 
                0 5px 8px rgba(0, 0, 0, 0.6); 
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
            border-bottom: 3px solid var(--gold-dark); 
        }
        #save-preset-btn:active {
            transform: translateY(1px); 
            box-shadow: 
                0 0 6px rgba(196, 154, 76, 0.4), 
                inset 0 0 3px rgba(0, 0, 0, 0.3),
                0 1px 2px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--gold-dark); 
        }


        /* --- Reset Button (Smaller) --- */
        #reset-eq-btn {
            margin-top: 1.5rem; 
            padding: 0.6rem; 
            font-size: 0.75rem; 
            font-weight: 500;
            border-radius: 0.75rem;
            background-color: #DC2626; 
            color: white;
            box-shadow: 
                0 0 8px rgba(220, 38, 38, 0.6), 
                inset 0 0 3px rgba(255, 255, 255, 0.3),
                0 3px 5px rgba(0, 0, 0, 0.5);
            border-bottom: 3px solid #991B1B; 
        }
        #reset-eq-btn:active {
             transform: translateY(1px);
            box-shadow: 
                0 0 4px rgba(220, 38, 38, 0.4), 
                inset 0 0 1px rgba(0, 0, 0, 0.2),
                0 1px 2px rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid #991B1B;
        }

        /* Fallback Logo Style (if image fails to load) */
        .logo-fallback {
            color: var(--gold-base);
            font-size: 1.25rem;
            font-weight: 700;
            padding: 0.5rem;
            border: 1px solid var(--gold-base);
            display: inline-block;
            text-align: center;
            width: 3.5rem;
            height: 3.5rem;
            line-height: 2.5rem;
        }

        /* Centering for button grids */
        .button-grid {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 0.5rem; 
            padding-bottom: 0.25rem; 
            overflow-x: hidden; 
            width: 100%;
        }

        /* NEW: Styles for Scan and Source Buttons (Match Gold Theme) */
        #scan-btn, #source-btn {
            background: linear-gradient(145deg, var(--gold-base), var(--gold-dark));
            color: #111111;
            padding: 0.5rem;
            font-size: 0.7rem;
            border-radius: 0.5rem;
            width: 100%;
            margin-bottom: 0.5rem;
            box-shadow: 0 0 10px rgba(196, 154, 76, 0.6);
        }
        #source-list {
            background-color: var(--card-background);
            padding: 1rem;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        #source-list button {
            background-color: transparent;
            color: var(--gold-light);
            border: 1px solid var(--gold-base);
            padding: 0.5rem;
            border-radius: 0.5rem;
            text-align: center;
        }

    </style>
</head>
<body class="min-h-screen">

    <div class="card">

        <header id="main-header-content">
            <img src="logo.png" 
                 alt="Meta-L Logo" 
                 onerror="this.onerror=null; this.src=''; this.alt='META-L LOGO'; this.classList.add('logo-fallback');" 
            />
            
            <h1 class="text-white uppercase">META-L</h1>
            <p class="text-gold-accent uppercase">Acoustic & Visual Ecstasy</p>
            
            <p id="app-status" class="text-xs font-light text-gray-700 pt-1">INITIALIZING...</p>
            <p id="user-id-display" class="text-[10px] text-gray-800 font-light truncate">LOADING USER...</p>

        </header>

        <section>
            <h3>Speaker Selector</h3>
            <div id="speaker-buttons-container" class="button-grid"> 
                
            </div>
        </section>

        <section>
            <h3>Bluetooth Devices</h3>
            <!-- NEW: Scan Button -->
            <button id="scan-btn">Scan for Devices</button>
            <div id="bluetooth-device-list" class="button-grid"> 
                
            </div>
        </section>
        
        <!-- NEW: MEDIA CONTROLS SECTION -->
        <section>
            <h3>Media Controls</h3>
            
            <!-- Volume Slider Control -->
            <div class="w-full mb-8 mt-4">
                <label for="volume-slider-media" class="block text-center text-sm font-medium mb-2 text-gray-400">Master Volume (<span id="volume-value-media">50</span>%)</label>
                <div class="flex items-center space-x-3">
                    <!-- Volume Down Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-gray-500">
                        <path d="M13.5 4.5a4.5 4.5 0 1 0 0 9 4.5 4.5 0 0 0 0-9zM6 18c0-.98.397-1.93 1.107-2.614C9.284 14.153 12.7 13.5 16.5 13.5c.31 0 .617.027.92.078.601-.58 1.15-1.127 1.642-1.625 1.76-1.76 1.76-4.661 0-6.42A4.5 4.5 0 0 0 13.5 4.5h-.088c-1.282 0-2.53.256-3.702.748L3 12.75c-1.55 1.55-1.55 4.07 0 5.62l3 3c1.55 1.55 4.07 1.55 5.62 0l-1.47-1.47a.75.75 0 1 0-1.06-1.06l-1.47 1.47a2.578 2.578 0 0 1-3.648 0 2.578 2.578 0 0 1 0-3.648L6 18z" />
                    </svg>
                    <!-- Volume Slider using default styling, but metallic thumb -->
                    <input type="range" id="volume-slider-media" min="0" max="100" value="50" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-gray-500">
                    <!-- Volume Up Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-gray-500">
                        <path fill-rule="evenodd" d="M13.5 4.5a4.5 4.5 0 1 0 0 9 4.5 4.5 0 0 0 0-9zM6 18c0-.98.397-1.93 1.107-2.614C9.284 14.153 12.7 13.5 16.5 13.5c.31 0 .617.027.92.078.601-.58 1.15-1.127 1.642-1.625 1.76-1.76 1.76-4.661 0-6.42A4.5 4.5 0 0 0 13.5 4.5h-.088c-1.282 0-2.53.256-3.702.748L3 12.75c-1.55 1.55-1.55 4.07 0 5.62l3 3c1.55 1.55 4.07 1.55 5.62 0l-1.47-1.47a.75.75 0 1 0-1.06-1.06l-1.47 1.47a2.578 2.578 0 0 1-3.648 0 2.578 2.578 0 0 1 0-3.648L6 18z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>

            <!-- Main Playback Controls -->
            <div class="flex justify-around items-center w-full max-w-xs mx-auto space-x-4">
                <!-- Previous Button (CORRECTED ICON) -->
                <button onclick="controlAction('previous')" class="control-button bg-gray-800 hover:bg-gray-700 text-gold-accent p-4 rounded-full w-14 h-14 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M16 4L9 12l7 8V4zM4 4h2v16H4V4z"/>
                    </svg>
                </button>
                
                <!-- Play/Pause Button (Large - Toggles Icons) -->
                <button onclick="togglePlayPause()" id="play-pause-btn" class="control-button text-black p-6 rounded-full w-20 h-20 flex items-center justify-center">
                    <!-- Play Icon (Shown when paused) -->
                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.427 1.529-2.38 2.831-1.664L21.112 12l-13.78 8.01c-1.303.717-2.831-.237-2.831-1.664V5.653z" clip-rule="evenodd" />
                    </svg>
                    <!-- Pause Icon (Hidden initially, shown when playing) -->
                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 hidden">
                        <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 0 1 .75-.75H9a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H7.5a.75.75 0 0 1-.75-.75V5.25zm7.5 0a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1-.75-.75V5.25z" clip-rule="evenodd" />
                    </svg>
                </button>
                
                <!-- Skip Button (CORRECTED ICON) -->
                <button onclick="controlAction('skip')" class="control-button bg-gray-800 hover:bg-gray-700 text-gold-accent p-4 rounded-full w-14 h-14 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M8 4l7 8-7 8V4zM20 4h-2v16h2V4z"/>
                    </svg>
                </button>
            </div>
            
            <!-- NEW: Source Button and List -->
            <button id="source-btn" class="mt-4">Source</button>
            <div id="source-list" class="hidden mt-2">
                <button onclick="openSource('youtube')">YouTube</button>
                <button onclick="openSource('spotify')">Spotify</button>
                <!-- Add more options here if needed -->
            </div>
            
        </section>
        
        <section id="eq-section">
            <h3>Equalizer Control</h3>
            
            <div id="preset-buttons" class="button-grid mb-4">
                
            </div>

            <button id="save-preset-btn" class="w-full">
                SAVE CUSTOM 1
            </button>


            <div class="eq-slider-group">
                
                <div class="eq-slider-item">
                    <div class="eq-label-row">
                        <span>Low</span>
                        <span id="low-value" class="eq-value">60</span>
                    </div>
                    <input type="range" id="low-slider" min="0" max="100" value="60">
                </div>

                <div class="eq-slider-item">
                    <div class="eq-label-row">
                        <span>Low-Mid</span>
                        <span id="lowMid-value" class="eq-value">65</span>
                    </div>
                    <input type="range" id="lowMid-slider" min="0" max="100" value="65">
                </div>

                <div class="eq-slider-item">
                    <div class="eq-label-row">
                        <span>Mid</span>
                        <span id="mid-value" class="eq-value">50</span>
                    </div>
                    <input type="range" id="mid-slider" min="0" max="100" value="50">
                </div>

                <div class="eq-slider-item">
                    <div class="eq-label-row">
                        <span>High-Mid</span>
                        <span id="highMid-value" class="eq-value">75</span>
                    </div>
                    <input type="range" id="highMid-slider" min="0" max="100" value="75">
                </div>

                <div class="eq-slider-item">
                    <div class="eq-label-row">
                        <span>High</span>
                        <span id="high-value" class="eq-value">70</span>
                    </div>
                    <input type="range" id="high-slider" min="0" max="100" value="70">
                </div>
            </div>

            <button id="reset-eq-btn" class="w-full">
                RESET TO FLAT
            </button>

        </section>

    </div>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('SW registered', reg))
      .catch(err => console.log('SW failed', err));
  });
}
</script>
</body>
    <body>
  <!-- Force PWABuilder to detect SW -->
  <link rel="service-worker" href="/sw.js">
  
  <!-- rest of your HTML -->
</html>
